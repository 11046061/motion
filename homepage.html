<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthy Life - 首頁</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/homepage.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Just+Another+Hand&display=swap" rel="stylesheet">
</head>
<body>
    
    <header>
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="Logo 1">
            <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Logo 2">
        </div>
        <h1>健身社交平台</h1>
        <nav>
            <ul>
                <li><a href="{{ url_for('homepage') }}" class="nav-link active">首頁</a></li>
                <li><a href="{{ url_for('plans') }}" class="nav-link">計畫</a></li>
                <li><a href="{{ url_for('search') }}" class="nav-link">搜尋</a></li>
                <li><a href="{{ url_for('profile') }}" class="nav-link">個人</a></li>
            </ul>
        </nav>
    </header>
   
    <!-- 主要內容區域 -->
    <main>
        <div id="posts-container">
            <!-- 貼文內容會顯示在這裡 -->
        </div>
    </main>

    <!-- 左側廣告區域 -->
    <div class="sidebar left">
        <a href="https://24h.pchome.com.tw/prod/DEBYLG-A900GPLSF" target="_blank">
            <img src="{{ url_for('static', filename='images/健身啞鈴廣告.jpg') }}" alt="左側廣告" class="ad-image">
        </a>            


    <!-- 健身新手規劃按鈕 -->
    <a href="https://www.womenshealthmag.com/tw/fitness/work-outs/g40829424/workout-plan/" target="_blank" class="certified-link">健身新手規劃</a>
    </div>

    <!-- 按鈕容器 -->


    <!-- 右側廣告區域 -->
    <div class="sidebar right">
        <div class="favorite-button-container">
            <button onclick="showFavorites()" class="favorite-button">查看珍藏的貼文</button>
        </div>

        <a href="https://m.momoshop.com.tw/goods.momo?i_code=12221717&mdiv=searchEngine&oid=1_1&kw=%E7%91%9C%E7%8F%88%E5%A2%8A" target="_blank">
            <img src="{{ url_for('static', filename='images/健身瑜珈墊廣告.png') }}" alt="右側廣告" class="ad-image">
        </a>            
    

    <!-- 專業健身菜單按鈕 -->
    <a href="https://tw.sports.yahoo.com/news/%E9%87%91%E5%AD%97%E5%A1%94%E8%A8%93%E7%B7%B4%E8%A9%B2%E6%80%8E%E9%BA%BC%E5%81%9A%EF%BC%9F%E6%AD%A3%E9%87%91%E5%AD%97%E5%A1%94%E3%80%81%E5%80%92%E9%87%91%E5%AD%97%E5%A1%94%E3%80%81%E5%85%A8%E9%87%91%E5%AD%97%E5%A1%94%E5%93%AA%E4%B8%80%E5%80%8B%E8%BC%83%E9%81%A9%E5%90%88%E6%88%91%EF%BC%9F-131518276.html" target="_blank" class="certified-link">金字塔訓練法</a>
</div>    
</body>
    
    <div class="create-post" onclick="showCreatePostModal()">+</div>
<!--新增貼文模組中的視窗 -->
<div class="create-post-modal" id="createPostModal">
    <div class="create-post-modal-content">
        <textarea id="post-text" placeholder="分享你的健身心得..."></textarea>
        
        <label for="post-image" class="upload-label">上傳圖片</label>
        <input type="file" id="post-image" name="image" multiple style="display: none;">

        <label for="post-video" class="upload-label">上傳影片</label>
        <input type="file" id="post-video" name="video" multiple style="display: none;">


        <div id="preview-container" class="preview-container"></div>

        <button onclick="createPost()">發佈</button>
    </div>
</div>

    
    
    <script>
        

        
        function createPost() {
            const text = document.getElementById('post-text').value;
            const imageFiles = Array.from(document.getElementById('post-image').files);  // 使用Array.from將FileList轉換為數組
            const videoFiles = Array.from(document.getElementById('post-video').files);  // 同樣處理影片

            const formData = new FormData();
            formData.append('content', text);

            imageFiles.forEach(file => formData.append('images', file));  // 添加圖片
            videoFiles.forEach(file => formData.append('videos', file));  // 添加影片

            fetch('/add_post', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    hideCreatePostModal();
                    location.reload();  // 發佈成功後重新加載頁面
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('發生錯誤，請稍後再試');
            });
        }





        
        
        

        function createPostHTML(post) {
            let content = '';
            const images = Array.isArray(post.images) ? post.images : JSON.parse(post.images || "[]");
            const videos = Array.isArray(post.videos) ? post.videos : JSON.parse(post.videos || "[]");
            const maxImages = 3;

            // 顯示圖片
            images.slice(0, maxImages).forEach((image, index) => {
                content += `<div class="image-wrapper" style="flex: 1;">
                                <img src="${image}" class="post-image" data-post-id="${post.id}" data-index="${index}" onclick="openImageModal(${post.id}, ${index})">
                            </div>`;
            });

            // 顯示 "+更多" 圖示
            if (images.length > maxImages) {
                const remaining = images.length - maxImages;
                content += `<div class="image-wrapper" style="flex: 1; position: relative;">
                                <img src="${images[maxImages]}" class="post-image" onclick="openImageModal(${post.id}, ${maxImages - 1})">
                                <div class="overlay">+${remaining}</div>
                            </div>`;
            }

            // 顯示影片
            const maxVideos = 3;
            videos.slice(0, maxVideos).forEach((video, index) => {
                content += `<div class="video-wrapper" style="flex: 1;">
                                <video src="${video}" class="post-video" controls onclick="openVideoModal(${post.id}, ${index})"></video>
                            </div>`;
            });

            if (videos.length > maxVideos) {
                const remaining = videos.length - maxVideos;
                content += `<div class="video-wrapper" style="flex: 1; position: relative;">
                                <video src="${videos[maxVideos]}" class="post-video" controls onclick="openVideoModal(${post.id}, ${maxVideos - 1})"></video>
                                <div class="overlay">+${remaining}</div>
                            </div>`;
            }

            // 顯示留言
            let commentsHTML = '';
            const comments = Array.isArray(post.comments) ? post.comments : (post.comments ? JSON.parse(post.comments) : []);
            if (comments.length > 0) {
                comments.forEach(comment => {
                    commentsHTML += `
                        <div class="comment" id="comment-${comment.id}">
                            <p><strong>${comment.username}:</strong> ${comment.content}</p>
                            <span class="comment-time">${formatTime(new Date(comment.created_at))}</span>
                            <div class="comment-actions">
                                <img src="${comment.user_liked ? "/static/images/like1.png" : "/static/images/like.png"}" alt="Like" class="action-icon like-icon" onclick="likeComment(${comment.id})">
                                <span class="comment-like-count">按讚: ${comment.likes}</span>
                                <img src="/static/images/mess.png" alt="Reply" class="action-icon reply-icon" onclick="showReplyBox(${comment.id})">
                                ${comment.deletable ? `<button onclick="deleteComment(${comment.id})">刪除</button>` : ''}
                            </div>
                            <div class="reply-section" id="replySection_${comment.id}" style="display:none;">
                                <textarea id="replyInput_${comment.id}" placeholder="輸入回覆..."></textarea>
                                <button class="reply-button" onclick="addReply(${comment.id})">傳送</button>
                            </div>
                        </div>`;
                });
            }

            // 按讚與珍藏圖示
            let likeIcon = post.user_liked ? "/static/images/like1.png" : "/static/images/like.png";
            let favoriteIcon = post.is_favorited ? "/static/images/collection1.png" : "/static/images/collection.png";

            // 最終HTML結構
            return `
                <div class="post" id="post-${post.id}">
                    <div class="post-header">
                        <img src="/static/images/avatar.png" alt="Avatar" class="avatar">
                        <div class="username">${post.username}</div>
                        <div class="post-time">${formatTime(new Date(post.created_at))}</div>
                        ${post.is_owner ? `<button onclick="deletePost(${post.id})">刪除</button>` : ''}
                    </div>
                    <div class="post-content">
                        <p>${post.content}</p>
                        <div class="media-container" style="display: flex;">
                            ${content}
                        </div>
                    </div>
                    <div class="post-actions">
                        <img src="${likeIcon}" alt="Like" class="action-icon like-icon" onclick="toggleLike(${post.id})">
                        <div class="like-count">按讚: ${post.likes || 0}</div>
                        <img src="${favoriteIcon}" alt="Favorite" class="action-icon favorite-icon" onclick="toggleFavorite(${post.id})">
                        <img src="/static/images/mess.png" alt="Comment" class="action-icon comment-icon" onclick="showCommentSection(${post.id})">
                        <div class="comment-count">留言: ${comments.length}</div>
                    </div>
                    <div class="comment-section" id="commentSection_${post.id}">
                        ${commentsHTML}
                        <div class="comment-input-container">
                            <textarea id="commentInput_${post.id}" placeholder="輸入留言..."></textarea>
                            <button class="comment-button" onclick="addComment(${post.id})">傳送</button>
                        </div>
                    </div>
                </div>`;
        }





        // 假設從後端獲取收藏貼文時儲存 posts 資料
        let posts = [];

        function fetchFavorites() {
            fetch('/get_favorites')
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched Favorites Data:", data); // 除錯用
                    if (data.status === "success") {
                        // 現有邏輯
                    }
                });
        }


        let currentIndex; // 全域變數，用於追蹤當前的圖片索引
        let images = []; // 全域變數，用於存儲當前帖子圖片的列表

        function openImageModal(postId, index) {
            // 找到對應的帖子
            const post = posts.find(p => p.id === postId);
            if (!post) {
                console.error("Post not found");
                return;
            }

            images = post.images; // 設置全域變數 images
            currentIndex = index; // 設置初始索引

            // 創建模態視窗
            const modal = document.createElement('div');
            modal.className = 'image-modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeImageModal()">×</button>
                    <img src="${images[currentIndex]}" class="modal-image" id="modal-image">
                    <div class="modal-controls">
                        <button onclick="prevImage()">‹</button>
                        <button onclick="nextImage()">›</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal); // 將模態視窗添加到頁面中

            // 控制模態視窗的顯示與關閉
            window.closeImageModal = function() {
                const modal = document.querySelector('.image-modal');
                if (modal) {
                    modal.remove();
                }
            };

            window.nextImage = function() {
                currentIndex = (currentIndex + 1) % images.length;
                document.getElementById('modal-image').src = images[currentIndex];
            };

            window.prevImage = function() {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
                document.getElementById('modal-image').src = images[currentIndex];
            };
        }

        function openVideoModal(postId, index) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
                    const videos = post.videos;
                    let currentIndex = index;

                    const modal = document.createElement('div');
            modal.className = 'video-modal active';
            modal.innerHTML = `
                <!-- 影片模態 -->
        <div id="videoModal" class="modal">
            <span class="close" id="videoModalClose">&times;</span>
            <video class="modal-content" id="modalVideo" controls></video>
            <a class="prev" id="prevVideo">&#10094;</a>
            <a class="next" id="nextVideo">&#10095;</a>
        </div>

            `;

            document.body.appendChild(modal);

            window.closeVideoModal = function() {
                modal.remove();
            };

            window.nextVideo = function() {
                currentIndex = (currentIndex + 1) % videos.length;
                document.getElementById('modal-video').src = videos[currentIndex];
            };

            window.prevVideo = function() {
                currentIndex = (currentIndex - 1 + videos.length) % videos.length;
                document.getElementById('modal-video').src = videos[currentIndex];
            };
        }


        


            
        
        function previewPost() {
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = ''; // 清空現有的預覽內容
            const files = Array.from(this.files);

            files.forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const mediaPreview = document.createElement(file.type.startsWith('image') ? 'img' : 'video');
                    mediaPreview.src = e.target.result;
                    mediaPreview.className = 'post-media-preview';
                    if (file.type.startsWith('video')) {
                        mediaPreview.controls = true;
                    }
                    previewContainer.appendChild(mediaPreview);
                };
                reader.readAsDataURL(file);
            });

            if (files.length > 3) {
                addArrows(previewContainer);
            }
        }

        function addArrows(container) {
            const leftArrow = document.createElement('div');
            leftArrow.className = 'arrow';
            leftArrow.innerHTML = '&#9664;';
            leftArrow.addEventListener('click', () => container.scrollBy({ left: -100, behavior: 'smooth' }));
            container.insertBefore(leftArrow, container.firstChild);

            const rightArrow = document.createElement('div');
            rightArrow.className = 'arrow';
            rightArrow.innerHTML = '&#9654;';
            rightArrow.addEventListener('click', () => container.scrollBy({ left: 100, behavior: 'smooth' }));
            container.appendChild(rightArrow);
        }


            
    
        // 儲存所有選中的檔案
let selectedFiles = [];

// 處理圖片和影片的上傳預覽和選擇
document.getElementById('post-image').addEventListener('change', function() {
    handleFileSelection(this, 'image');
});

document.getElementById('post-video').addEventListener('change', function() {
    handleFileSelection(this, 'video');
});

function handleFileSelection(inputElement, type) {
    const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    const allowedVideoTypes = ['video/mp4', 'video/webm'];
    const previewContainer = document.getElementById('preview-container');
    const files = Array.from(inputElement.files);
    
    // 清空現有的預覽內容，避免重複顯示
    previewContainer.innerHTML = '';

    // 更新 selectedFiles，將新選擇的檔案添加到已選檔案列表中
    files.forEach(file => {
        // 檢查檔案格式和大小
        const isValidType = (type === 'image' && allowedImageTypes.includes(file.type)) ||
                            (type === 'video' && allowedVideoTypes.includes(file.type));
        const isValidSize = file.size <= 5 * 1024 * 1024;

        if (!isValidType) {
            alert('只允許上傳 JPG, PNG 圖片或 MP4, WebM 視頻');
            return;
        }
        if (!isValidSize) {
            alert('檔案大小不可超過 5MB');
            return;
        }

        selectedFiles.push(file);
    });

    // 顯示有效的預覽
    selectedFiles.forEach((file, index) => {
        // 創建預覽容器
        const previewWrapper = document.createElement('div');
        previewWrapper.className = 'preview-wrapper';

        // 創建預覽元素
        const previewElement = document.createElement(file.type.startsWith('image') ? 'img' : 'video');
        previewElement.src = URL.createObjectURL(file);
        previewElement.className = 'post-media-preview';
        previewElement.controls = file.type.startsWith('video');

        // 添加「X」按鈕
        const removeButton = document.createElement('div');
        removeButton.innerHTML = 'X';
        removeButton.className = 'remove-button';
        removeButton.addEventListener('click', function() {
            // 從 selectedFiles 中移除該檔案
            selectedFiles = selectedFiles.filter((_, i) => i !== index);
            previewWrapper.remove();  // 移除該預覽項目
        });

        // 將預覽元素和刪除按鈕添加到包裝容器
        previewWrapper.appendChild(previewElement);
        previewWrapper.appendChild(removeButton);
        previewContainer.appendChild(previewWrapper);
    });

    // 清空 input 值，避免多次選擇相同檔案失敗
    inputElement.value = '';
}

// 發佈貼文時使用 selectedFiles 中的檔案
function createPost() {
    const text = document.getElementById('post-text').value;

    // 初始化 FormData 並添加文字內容
    const formData = new FormData();
    formData.append('content', text);

    // 將 selectedFiles 中的檔案加入 formData
    selectedFiles.forEach(file => {
        if (file.type.startsWith('image')) {
            formData.append('images', file);
        } else if (file.type.startsWith('video')) {
            formData.append('videos', file);
        }
    });

    // 發送請求到後端
    fetch('/add_post', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert("貼文發佈成功");
            // 清空 selectedFiles 和預覽
            selectedFiles = [];
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('post-text').value = '';
            hideCreatePostModal();
            location.reload();  // 發佈成功後重新加載頁面
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('發生錯誤，請稍後再試');
    });
}





        function createCommentHTML(comment) {
        let likeIcon = comment.user_liked ? "{{ url_for('static', filename='images/like1.png') }}" : "{{ url_for('static', filename='images/like.png') }}";

        return `
            <div class="comment" id="comment-${comment.id}">
                <p><strong>${comment.username}:</strong> ${comment.content}</p>
                <span class="comment-time">${formatTime(new Date(comment.created_at))}</span>
                <div class="comment-actions">
                    <img src="${likeIcon}" alt="Like" class="action-icon like-icon" onclick="likeComment(${comment.id})">
                    <span class="comment-like-count">按讚: ${comment.likes}</span>
                    <img src="{{ url_for('static', filename='images/mess.png') }}" alt="Reply" class="action-icon reply-icon" onclick="showReplyBox(${comment.id})">
                    ${comment.deletable ? `<button onclick="deleteComment(${comment.id})">刪除</button>` : ''}
                </div>
                <div class="reply-section" id="replySection_${comment.id}" style="display: none;">
                    <textarea id="replyInput_${comment.id}" placeholder="輸入回覆..."></textarea>
                    <button class="reply-button" onclick="addReply(${comment.id})">傳送</button>
                </div>
                <div class="replies-container" id="repliesContainer_${comment.id}">
                    <!-- 回覆將顯示在這裡 -->
                </div>
            </div>
        `;
    }






        

        function replyToComment(commentId, username) {
            const replySection = document.getElementById(`replySection_${commentId}`);
            replySection.style.display = 'block';
            const replyInput = document.getElementById(`replyInput_${commentId}`);
            replyInput.value = `@${username} `;
            replyInput.focus();
        }
        function showReplyBox(commentId) {
            const replySection = document.getElementById(`replySection_${commentId}`);
            replySection.style.display = replySection.style.display === 'block' ? 'none' : 'block';
        }
        function addReply(commentId) {
            const replyInput = document.getElementById(`replyInput_${commentId}`);
            const replyText = replyInput.value.trim();
            const postId = document.querySelector(`#comment-${commentId}`).closest('.post').id.split('-')[1]; // 获取 post_id
            
            if (replyText) {
                fetch('/add_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ post_id: postId, content: replyText, parent_comment_id: commentId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 插入新的回覆，避免重新渲染整個留言區
                        const repliesContainer = document.getElementById(`repliesContainer_${commentId}`);
                        if (repliesContainer) {
                            repliesContainer.innerHTML += `
                                <div class="comment" id="comment-${data.comment_id}">
                                    <p><strong>${data.username}:</strong> ${replyText}</p>
                                    <span class="comment-time">${formatTime(new Date())}</span>
                                    <img src="{{ url_for('static', filename='images/like.png') }}" alt="Like" class="action-icon like-icon" onclick="likeComment(${data.comment_id})">
                                    <span class="comment-like-count">按讚: 0</span>
                                    ${data.deletable ? `<button onclick="deleteComment(${data.comment_id})">刪除</button>` : ''}
                                </div>
                            `;
                            replyInput.value = '';  // 清空輸入框
                            document.getElementById(`replySection_${commentId}`).style.display = 'none';  // 隱藏回覆區
                        }
                        // 更新總留言數
                        updateCommentCount(postId);
                    } else {
                        alert('回覆提交失敗：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('發生錯誤，請稍後重試。');
                });
            } else {
                alert('請輸入回覆內容');
            }
        }




        function updateCommentCount(postId) {
            const commentCountElement = document.querySelector(`#post-${postId} .comment-count`);
            fetch(`/get_comment_count/${postId}`)
                .then(response => response.json())
                .then(data => {
                    // 將總數顯示出來，包括回覆
                    commentCountElement.innerHTML = `留言: ${data.count}`;
                });
        }


        function showCommentSection(postId) {
            const commentSection = document.getElementById(`commentSection_${postId}`);
            commentSection.style.display = commentSection.style.display === 'block' ? 'none' : 'block';
        }

        function addComment(postId) {
            const commentInput = document.getElementById(`commentInput_${postId}`);
            const commentText = commentInput.value.trim();

            if (commentText) {
                const sendButton = document.querySelector('.comment-button');
                sendButton.disabled = true;  // 禁用按鈕，防止多次提交

                fetch('/add_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ post_id: postId, content: commentText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        sendButton.disabled = false;  // 成功後重新啟用按鈕
                        
                        // 清空留言區，避免重複顯示
                        const commentSection = document.getElementById(`commentSection_${postId}`);
                        commentSection.innerHTML = '';  // 先清空現有留言
                        
                        // 渲染新留言和其他留言
                            fetchCommentsAndRender(postId);  // 使用新的函數來重新渲染所有留言

                            updateCommentCount(postId);  // 更新留言數
                            commentInput.value = '';  // 清空輸入框
                        } else {
                            alert('提交失敗');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    sendButton.disabled = false;  // 發生錯誤時重新啟用按鈕
                });
            } else {
                alert('請輸入留言內容');
            }
        }



        function fetchCommentsAndRender(postId) {
            fetch(`/get_comments?post_id=${postId}`)
                .then(response => response.json())
                .then(data => {
                    const commentSection = document.getElementById(`commentSection_${postId}`);
                    commentSection.innerHTML = '';  // 清空留言區
                    data.comments.forEach(comment => {
                        const commentHTML = createCommentHTML(comment);
                        commentSection.innerHTML += commentHTML;
                    });
                })
                .catch(error => console.error('Error fetching comments:', error));
        }



        function formatTime(time) {
            const now = new Date();
            const diff = (now - time) / 1000;
            if (diff < 60) return '剛剛';
            if (diff < 3600) return `${Math.floor(diff / 60)}分鐘前`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}小時前`;
            return `${Math.floor(diff / 86400)}天前`;
        }

        function toggleLike(postId) {
            const likeIcon = document.querySelector(`#post-${postId} .like-icon`);
            const likeCount = likeIcon.nextElementSibling;  // 按讚數顯示元素
            fetch('/like_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    likeIcon.src = data.user_liked ? "{{ url_for('static', filename='images/like.png') }}" : "{{ url_for('static', filename='images/like1.png') }}";
                    likeIcon.nextElementSibling.innerHTML = `按讚: ${data.likes}`;
                }
            })
            .catch(error => console.error('Error:', error));
        }

 
        

        const likeIconUrl = "{{ url_for('static', filename='images/like.png') }}";
        const like1IconUrl = "{{ url_for('static', filename='images/like1.png') }}";

        function likeComment(commentId) {
            fetch('/like_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment_id: commentId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const comment = document.querySelector(`#comment-${commentId}`);
                    if (comment) {
                        const likeCount = comment.querySelector('.comment-like-count');
                        likeCount.innerHTML = `按讚: ${data.likes}`;  // 更新按讚數

                        const likeIcon = comment.querySelector('.like-icon');
                        if (data.user_liked) {
                            likeIcon.src = like1IconUrl;  // 更新為紅色實心圖示
                        } else {
                            likeIcon.src = likeIconUrl;  // 更新為空心圖示
                        }
                    }
                } else {
                    alert('按讚失敗: ' + data.message);
                }
            })
            .catch(error => console.error('按讚錯誤:', error));
        }

   

        function deleteComment(commentId) {
            fetch(`/delete_comment/${commentId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById(`comment-${commentId}`).remove();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }


        function deletePost(postId) {
            // 發送刪除請求到後端
            fetch(`/delete_post/${postId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 刪除成功後，從 DOM 中移除這個貼文
                    const postElement = document.getElementById(`post-${postId}`);
                    if (postElement) {
                        postElement.remove();  // 移除該貼文的 HTML 元素
                    }
                } else {
                    alert(data.message);  // 如果刪除失敗，顯示錯誤訊息
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('刪除失敗，請稍後再試');
            });
        }


        function unlikePost(postId) {
            fetch('/unlike_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            });
        }

        function toggleFavorite(postId) {
            fetch('/toggle_favorite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 切換圖示，根據是否已珍藏改變圖示
                    const favoriteIcon = document.querySelector(`#post-${postId} .favorite-icon`);
                    favoriteIcon.src = data.action === 'favorited' 
                        ? "{{ url_for('static', filename='images/collection1.png') }}" 
                        : "{{ url_for('static', filename='images/collection.png') }}";
                } else {
                    alert('操作失敗，請稍後再試');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function showFavorites() {
            fetch('/get_favorites')
                .then(response => response.json())
                .then(data => {
                    console.log(data);  // 檢查返回的 JSON 資料

                    if (data.status === 'success') {
                        const postsContainer = document.getElementById('posts-container');
                        postsContainer.innerHTML = '';  // 清空貼文區域

                        // 檢查 favorites 陣列是否有內容
                        if (data.favorites.length === 0) {
                            postsContainer.innerHTML = '<p>目前沒有珍藏的貼文。</p>';
                            return;
                        }

                        // 生成每個珍藏貼文的 HTML
                        data.favorites.forEach(post => {
                            const postHTML = createPostHTML(post);  // 使用現有函數生成貼文HTML
                            postsContainer.innerHTML += postHTML;
                        });
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }






        function showCreatePostModal() {
            document.getElementById('createPostModal').style.display = 'flex';
        }

        function hideCreatePostModal() {
            document.getElementById('createPostModal').style.display = 'none';
        }

        

        window.onclick = function(event) {
            if (event.target == document.getElementById('createPostModal')) {
                hideCreatePostModal();
            }
        }
        

        document.addEventListener('DOMContentLoaded', function() {
            let currentPostImages = [];
            let currentImageIndex = 0;
            let currentPostVideos = [];
            let currentVideoIndex = 0;

            fetch('/get_posts')
                .then(response => response.json())
                .then(data => {
                    console.log(data.posts);  // 檢查後端返回的資料結構
                    const postsContainer = document.getElementById('posts-container');
                    postsContainer.innerHTML = ''; // 清空容器

                    data.posts.forEach(post => {
                        console.log(`Post ID: ${post.id}, Is Owner: ${post.is_owner}`);  // 調試輸出
                        const postHTML = createPostHTML(post);  // 生成貼文HTML
                        postsContainer.innerHTML += postHTML;

                        // 渲染留言
                        renderComments(post);
                    });
                })
                .catch(error => {
                    console.error('載入貼文時出錯:', error);
                });

            // 渲染留言與回覆
            function renderComments(post) {
                const commentSection = document.getElementById(`commentSection_${post.id}`);
                
                // 清空現有留言
                commentSection.innerHTML = '';

                // 渲染父級留言
                post.comments.forEach(comment => {
                    if (!comment.parent_comment_id) {
                        const commentHTML = createCommentHTML(comment);
                        commentSection.innerHTML += commentHTML;
                    }
                });
                
                // 重新附加留言輸入框
                const commentInputBoxHTML = `
                    <div class="comment-input-container">
                        <textarea id="commentInput_${post.id}" placeholder="輸入留言..."></textarea>
                        <button class="comment-button" onclick="addComment(${post.id})">傳送</button>
                    </div>
                `;
                commentSection.innerHTML += commentInputBoxHTML;

                // 渲染回覆，將回覆嵌套到對應的父留言中
                post.comments.forEach(comment => {
                    if (comment.parent_comment_id) {
                        const repliesContainer = ensureRepliesContainer(comment.parent_comment_id);
                        
                        // 避免重複渲染回覆
                        if (!document.getElementById(`comment-${comment.id}`)) {
                            const replyHTML = createCommentHTML(comment);
                            repliesContainer.innerHTML += replyHTML;
                        }
                    }
                });
            }

            function ensureRepliesContainer(parentCommentId) {
                let repliesContainer = document.getElementById(`repliesContainer_${parentCommentId}`);
                if (!repliesContainer) {
                    const parentComment = document.getElementById(`comment-${parentCommentId}`);
                    if (parentComment) {
                        repliesContainer = document.createElement('div');
                        repliesContainer.id = `repliesContainer_${parentCommentId}`;
                        repliesContainer.className = 'replies-container';
                        parentComment.appendChild(repliesContainer);
                    }
                }
                return repliesContainer;
            }
});

            


        // 為所有圖片和影片添加點擊事件
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('post-image')) {
                event.preventDefault();
                const postId = event.target.dataset.postId;
                const index = parseInt(event.target.dataset.index);

                fetch(`/get_post_images/${postId}`)
                    .then(response => response.json())
                    .then(data => {
                        currentPostImages = data.images;
                        currentImageIndex = index;
                        openImageModal();
                        showImage(currentImageIndex);
                    });
            }   
                else if (event.target.classList.contains('post-video')) {
                    event.preventDefault();
                    const postId = event.target.dataset.postId;
                    const index = parseInt(event.target.dataset.index);

                fetch(`/get_post_videos/${postId}`)
                    .then(response => response.json())
                    .then(data => {
                        currentPostVideos = data.videos;
                        currentVideoIndex = index;
                        openVideoModal();
                        showVideo(currentVideoIndex);
                    });
            }
            


            let currentZoomLevel = 1;

            function zoomIn() {
                currentZoomLevel += 0.1;
                document.querySelector('.modal-image').style.transform = `scale(${currentZoomLevel})`;
            }

            function zoomOut() {
                if (currentZoomLevel > 0.1) {
                    currentZoomLevel -= 0.1;
                    document.querySelector('.modal-image').style.transform = `scale(${currentZoomLevel})`;
                }
            }


        // 開啟圖片模態
        function openImageModal(index) {
                document.getElementById('imageModal').style.display = 'block';
                showImage(index);
            }
        // 關閉圖片模態
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // 顯示當前圖片
        function showImage(index) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = currentPostImages[index];
        }

        // 綁定下一張圖片按鈕事件
        document.getElementById('nextImage').addEventListener('click', function() {
            currentImageIndex = (currentImageIndex + 1) % currentPostImages.length;
            showImage(currentImageIndex);
        });

        // 綁定上一張圖片按鈕事件
        document.getElementById('prevImage').addEventListener('click', function() {
            currentImageIndex = (currentImageIndex - 1 + currentPostImages.length) % currentPostImages.length;
            showImage(currentImageIndex);
        });

        // 關閉模態視窗按鈕
        document.getElementById('modalClose').addEventListener('click', function() {
            closeImageModal();
        });

        // 開啟影片模態
        function openVideoModal(index) {
                document.getElementById('videoModal').style.display = 'block';
                showVideo(index);
            }

        // 關閉影片模態
        function closeVideoModal() {
            const modalVideo = document.getElementById('modalVideo');
            modalVideo.pause(); // 暫停影片播放
            document.getElementById('videoModal').style.display = 'none';
        }

        // 顯示當前影片
        function showVideo(index) {
            const modalVideo = document.getElementById('modalVideo');
            modalVideo.src = currentPostVideos[index];
            modalVideo.play();
        }

        // 綁定下一個影片按鈕事件
        document.getElementById('nextVideo').addEventListener('click', function() {
            currentVideoIndex = (currentVideoIndex + 1) % currentPostVideos.length;
            showVideo(currentVideoIndex);
        });

        // 綁定上一個影片按鈕事件
        document.getElementById('prevVideo').addEventListener('click', function() {
            currentVideoIndex = (currentVideoIndex - 1 + currentPostVideos.length) % currentPostVideos.length;
            showVideo(currentVideoIndex);
        });

        // 關閉模態視窗按鈕
        document.getElementById('videoModalClose').addEventListener('click', function() {
            closeVideoModal();
        });

        // 點擊模態外部關閉模態
        window.addEventListener('click', function(event) {
            if (event.target == document.getElementById('imageModal')) {
                closeImageModal();
            } else if (event.target == document.getElementById('videoModal')) {
                closeVideoModal();
                }
            });
        });

    </script>
<!-- 確保模態視窗在頁面載入時就存在 -->
<div id="imageModal" class="modal">
    <span class="close" id="modalClose">&times;</span>
    <img class="modal-content" id="modalImage">
    <div class="modal-caption" id="modalCaption"></div>
    <a class="prev" id="prevImage">&#10094;</a>
    <a class="next" id="nextImage">&#10095;</a>
    <div class="modal-controls">
    
        <!-- <button onclick="zoomIn()">放大</button>
        <button onclick="zoomOut()">縮小</button> -->
    </div>
</div>

<div id="videoModal" class="modal">
    <span class="close" id="videoModalClose">&times;</span>
    <video class="modal-content" id="modalVideo" controls></video>
    <a class="prev" id="prevVideo">&#10094;</a>
    <a class="next" id="nextVideo">&#10095;</a>
</div>
</body>
</html>